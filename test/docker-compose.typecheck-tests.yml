version: "3.8"

# environment variable PWD is assumed to be grapl root directory

services:

  #
  # Python services
  #
  # All of these either are, or depend on, grapl-analyzerlib, which
  # must be typechecked with PyType at the moment. Due to a bug in how
  # Pants invokes MyPy, it will attempt to typecheck grapl-analyzerlib
  # even when only being instructed to typecheck something that
  # depends on it.
  #
  # Until we can type grapl-analyzerlib with MyPy, we'll need to
  # typecheck these libraries here.

  typecheck-analyzer-executor:
    image: grapl/analyzer-executor-test:${TAG:-latest}
    build:
      context: ${PWD}/src
      dockerfile: ./python/Dockerfile
      target: analyzer-executor-test
    command: |
      /bin/bash -c "
        source venv/bin/activate &&
        pip install mypy &&
        mypy analyzer_executor/**/*.py
        "

  typecheck-e2e-tests:
    image: grapl/grapl-e2e-tests-build:${TAG:-latest}
    build:
      context: ${PWD}/src
      dockerfile: ./python/Dockerfile
      target: grapl-e2e-tests-build
    command: |
      /bin/bash -c "
        source venv/bin/activate &&
        pip install mypy &&
        mypy -p grapl_e2e_tests
        "

  typecheck-grapl-analyzerlib:
    image: grapl/grapl-analyzerlib-test:${TAG:-latest}
    build:
      context: ${PWD}/src
      dockerfile: ./python/Dockerfile
      target: grapl-analyzerlib-test
    command: |
      /bin/bash -c "
        source venv/bin/activate &&
        cd grapl_analyzerlib &&
        pip install '.[typecheck]' &&
        pytype --config ./pytype.cfg .
        "
